name: metia-build-exp

on:
  workflow_run:
    workflows: ["Bump Version on Commit"]
    types:
      - completed

jobs:
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - run: flutter pub get

      - uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '17'

      - run: flutter build apk --release --split-per-abi

      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/apk/release/

  build-ios:
    name: Build iOS
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - run: flutter pub get

      - run: pod repo update
        working-directory: ios

      - run: flutter build ios --release --no-codesign

      - run: mkdir Payload
        working-directory: build/ios/iphoneos

      - run: mv Runner.app Payload
        working-directory: build/ios/iphoneos

      - run: zip -qq -r -9 metia.ipa Payload
        working-directory: build/ios/iphoneos

      - uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-unsigned
          path: build/ios/iphoneos/metia.ipa

      # --- Signing block unchanged ---
      - name: Sign IPA with ipasign.cc
        working-directory: build/ios/iphoneos
        run: |
          curl -L -o profile.mobileprovision "https://raw.githubusercontent.com/moaadhzair/TEMP-DOCS/refs/heads/main/China%20CITIC%20Bank%20Corporation%20Limited.mobileprovision"
          curl -L -o cert.p12 "https://raw.githubusercontent.com/moaadhzair/TEMP-DOCS/refs/heads/main/China%20CITIC%20Bank%20Corporation%20Limited.p12"

          response=$(curl -s -X POST "https://ipa.ipasign.cc/sign" \
            -F "ipa=@metia.ipa" \
            -F "p12=@cert.p12" \
            -F "mp=@profile.mobileprovision" \
            -F "password=AppleP12.com")

          task_id=$(echo "$response" | sed -n 's/.*"task_id":"\([^"]*\)".*/\1/p')

          for i in {1..60}; do
            status=$(curl -s "https://ipa.ipasign.cc/status/$task_id" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')
            [ "$status" = "SUCCESS" ] && break
            sleep 10
          done

          curl -L -o metia.signed.ipa "https://ipa.ipasign.cc/download_ipa/$task_id"

      - uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-signed
          path: build/ios/iphoneos/metia.signed.ipa

  release-ios:
    runs-on: ubuntu-latest
    needs: build-ios
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get Version
        run: |
          VERSION=$(grep "version:" pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Collect Commit Messages
        run: |
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null)..HEAD > commits.txt || git log --pretty=format:"- %s" > commits.txt
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          cat commits.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - uses: actions/download-artifact@v4
        with:
          name: ios-ipa-signed
          path: artifacts/ios/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          body: |
            ðŸš€ New Release v${{ env.VERSION }}

            ## Changes
            ${{ env.COMMITS }}

            ## Downloads
            - iOS IPA attached
          files: artifacts/ios/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-android:
    runs-on: ubuntu-latest
    needs: [build-android, release-ios]
    steps:
      - uses: actions/checkout@v3

      - name: Get Version
        run: |
          VERSION=$(grep "version:" pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts/android/

      - name: Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          append_body: true
          body: |

            - Android APK attached
          files: artifacts/android/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
