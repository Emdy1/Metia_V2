name: Build iOS
on:
  push:
    branches:
      - main
env:
  FLUTTER_CHANNEL: 'stable'
jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          architecture: x64
      - name: Get dependencies
        run: flutter pub get
      - name: Update CocoaPods repo
        run: pod repo update
        working-directory: ios
      - name: Download provisioning profile
        run: |
          curl -sL -o "profile.mobileprovision" \
            "https://raw.githubusercontent.com/moaadhzair/TEMP-DOCS/refs/heads/main/China%20CITIC%20Bank%20Corporation%20Limited.mobileprovision"
      - name: Download signing certificate
        run: |
          curl -sL -o "cert.p12" \
            "https://raw.githubusercontent.com/moaadhzair/TEMP-DOCS/refs/heads/main/China%20CITIC%20Bank%20Corporation%20Limited.p12"
      - name: Import signing certificate to keychain
        run: |
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import cert.p12 -k build.keychain -P "$CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool,apple:,codesign -s -k "$KEYCHAIN_PASSWORD" build.keychain
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
      - name: Build iOS with Xcode
        run: |
          flutter build ios --release \
            --build-number=${{ github.run_number }} \
            --export-method=app-store
      - name: Create IPA with xcodebuild
        run: |
          xcodebuild -exportArchive \
            -archivePath build/ios/archive.xcarchive \
            -exportPath build/ios/iphoneos \
            -exportOptionsPlist ExportOptions.plist
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-signed
          path: build/ios/iphoneos/*.ipa
          retention-days: 7
